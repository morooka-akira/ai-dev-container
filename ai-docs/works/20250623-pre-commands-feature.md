# Task 5-2: 事前コマンド実行機能の実装

## 作業日
2025年6月23日

## 作業概要
workspace start コマンド実行時に、設定ファイル（workspace.yml）で指定された pre_commands を新しく作成されたワークスペースで自動実行する機能を実装する。

## 設計・検討内容

### 1. 機能要件
- 設定ファイルの `pre_commands` 配列に指定されたコマンドを順次実行
- 新しく作成されたワークスペースディレクトリ内で実行
- コマンドが失敗しても処理を継続
- 実行結果（成功/失敗）を適切に表示
- 実行時間の長いコマンドでもUIがブロックしないよう配慮

### 2. 実装方針

#### 2.1 コマンド実行のタイミング
- ファイルコピー処理完了後に実行
- ワークスペース作成の最終ステップとして位置づけ

#### 2.2 実行環境
- 新しく作成されたワークスペースディレクトリをカレントディレクトリとして設定
- 各コマンドは独立して実行（前のコマンドの失敗が次のコマンドに影響しない）

#### 2.3 エラーハンドリング
- コマンドが失敗した場合: 警告メッセージを表示して続行
- コマンドの終了コードを確認して成功/失敗を判定
- 標準出力と標準エラー出力の両方をキャプチャ
- 全体的な処理は中断しない

### 3. 実装詳細

#### 3.1 workspace.rsへの追加
```rust
fn execute_pre_commands(&self, workspace_path: &Path, pre_commands: &[String]) {
    for command in pre_commands {
        // 実装
    }
}
```

#### 3.2 コマンド実行
- `std::process::Command` を使用
- シェルコマンドの実行（sh -c "command"）
- タイムアウト設定（長時間実行されるコマンドへの対策）

#### 3.3 必要な依存関係
- 標準ライブラリの `std::process` を使用
- 追加のクレートは現時点では不要

### 4. セキュリティ考慮事項
- コマンドインジェクション攻撃の防止
- 設定ファイルは信頼できるソースからのみ読み込む
- 危険なコマンドの実行に関する警告表示

## 作業リスト

1. [ ] workspace.rsに`execute_pre_commands`メソッドを追加
   - [ ] 各コマンドの実行ロジック
   - [ ] 作業ディレクトリの設定
   - [ ] 実行結果の表示
   - [ ] エラーハンドリング

2. [ ] create_workspace_with_config関数からexecute_pre_commandsメソッドを呼び出し
   - [ ] ファイルコピー完了後に呼び出し
   - [ ] 設定ファイルのpre_commandsを渡す

3. [ ] テストの作成
   - [ ] コマンドが正常に実行されるテスト
   - [ ] 失敗したコマンドのスキップテスト
   - [ ] 複数コマンドの順次実行テスト
   - [ ] 作業ディレクトリが正しく設定されるテスト

4. [ ] 統合テスト
   - [ ] 実際のworkspace startコマンドでpre_commandsが実行されることを確認

## テスト計画

### ユニットテスト
- `execute_pre_commands`メソッドの個別テスト
- 簡単なコマンド（echo、ls等）を使用したテスト

### 統合テスト  
- テスト用の設定ファイルを作成（簡単なコマンドを指定）
- workspace startコマンドを実行
- 作成されたワークスペースでコマンドが実行されたことを確認

## 注意事項
- 長時間実行されるコマンド（npm install、cargo build等）への配慮
- プラットフォーム依存のコマンドへの対応（Windows/Unix系）
- コマンドが無限ループしないようなタイムアウト機能は今回のスコープ外
- セキュリティ: 任意のコマンド実行のリスクを認識し、設定ファイルの信頼性を前提とする